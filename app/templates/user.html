{% extends "base.html" %}

{% block title %}User Profile{% endblock %}

{% block content %}
<section class="container-left">
    <!-- å·¦ä¾§å¯¼èˆªæ  -->
    <div class="sidebar">
        <a href="javascript:void(0);" class="nav-link" onclick="showSection('category-section')">Finding</a>
        <a href="javascript:void(0);" class="nav-link" onclick="showSection('trend-section')">Sentiment Trend</a>
        <a href="javascript:void(0);" class="nav-link" onclick="showSection('distribution-section')">Overall Sentiment
            Distribution</a>
        <a href="javascript:void(0);" class="nav-link" onclick="showSection('activity-section')">Daily Post Activity</a>
    </div>

    <!-- å³ä¾§å›¾è¡¨å†…å®¹ -->
    <div class="content">
        <!-- å¼•å¯¼ä»‹ç» -->
        <div id="top-feature" class="alert alert-light border rounded p-4 mb-4 shadow-sm">
            <h5><strong>Curious about what people your age or gender are interested in? ğŸ§</strong>
            </h5>
            <p>
                With our smart filtering feature, you can explore the most popular news categories among different age
                groups and genders in just one click! ğŸ”
                Discover trending topics, find common interests, or spark new curiosity. Whether you're tracking the
                latest buzz ğŸŒ or looking for more personalized content ğŸ¯,
                this feature gives you valuable insights to make your reading more focused and fun.
            </p>
            <p><strong>Try it now and uncover your unique news world! ğŸ’¥ğŸ—ï¸</strong></p>
        </div>
        <!-- å¹´é¾„å’Œæ€§åˆ« -->
        <!-- å½“å‰ç”¨æˆ·ä¿¡æ¯ -->
        <form method="POST" class="mb-4">
            {{ form.hidden_tag() }}
            <div class="row">
                <!-- ä¸€æ¬¡æ€§ä¿å­˜çš„å¹´é¾„ -->
                <div class="col-md-3">
                    <label>Age</label>
                    <input name="age" type="number" class="form-control" value="{{ user.age or '' }}">
                </div>

                <!-- ä¸€æ¬¡æ€§ä¿å­˜çš„æ€§åˆ« -->
                <div class="col-md-3">
                    <label>Gender</label>
                    <select name="gender" class="form-control">
                        <option value="">Select</option>
                        <option value="Male" {% if user.gender=='Male' %}selected{% endif %}>Male</option>
                        <option value="Female" {% if user.gender=='Female' %}selected{% endif %}>Female</option>
                        <option value="Other" {% if user.gender=='Other' %}selected{% endif %}>Other</option>
                    </select>
                </div>

                <!-- ç”¨äºç­›é€‰ï¼šæŒ‰æ€§åˆ« -->
                <div class="col-md-3">
                    <label>Filter by Gender</label>
                    <select name="gender_filter" class="form-control">
                        <option value="">None</option>
                        <option value="Male" {% if gender_filter=='Male' %}selected{% endif %}>Male</option>
                        <option value="Female" {% if gender_filter=='Female' %}selected{% endif %}>Female</option>
                        <option value="Other" {% if gender_filter=='Other' %}selected{% endif %}>Other</option>
                    </select>
                </div>

                <!-- ç”¨äºç­›é€‰ï¼šæŒ‰å¹´é¾„æ®µ -->
                <div class="col-md-3">
                    <label>Filter by Age Group</label>
                    <select name="age_group" class="form-control">
                        <option value="">None</option>
                        <option value="20-30" {% if age_group=='20-30' %}selected{% endif %}>20â€“30</option>
                        <option value="30-40" {% if age_group=='30-40' %}selected{% endif %}>30â€“40</option>
                        <option value="40-50" {% if age_group=='40-50' %}selected{% endif %}>40â€“50</option>
                        <option value="50-60" {% if age_group=='50-60' %}selected{% endif %}>50â€“60</option>
                        <option value="60-70" {% if age_group=='60-70' %}selected{% endif %}>60â€“70</option>
                    </select>
                </div>
            </div>

            <div class="mt-3">
                <button type="submit" class="btn btn-primary">Apply Filters</button>
            </div>
        </form>

        {% if gender_filter %}
        <h5>News Category Distribution for Gender: {{ gender_filter }}</h5>
        {% elif age_group %}
        <h5>News Category Distribution for Age Group: {{ age_group }}</h5>
        {% endif %}

        {% if category_distribution %}
        <!-- Category Distribution Chart Card -->
        <div id="category-section" class="chart-section card shadow-sm rounded mb-4">
            <div class="card-body">
                <h5 class="card-title text-center">Category Distribution (Bar Chart)</h5>
                <canvas id="categoryChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
        {% endif %}

        <h2 id="statistics-section" class="mb-4 text-center">ğŸ“Š User Statistics</h2>
        <!-- å¼•å¯¼ä»‹ç» -->
        <div class="alert alert-light border rounded p-4 mb-4 shadow-sm">
            <h5><strong>Your Mood, Your Moments â€” Visualized ğŸ’¬</strong></h5>
            <p>
                ğŸ“ˆ <strong>Sentiment Trend</strong><br>
                Track how your own emotions shift over time based on your posts. See patterns in your mood and emotional
                expression.<br><br>

                ğŸ“Š <strong>Overall Sentiment Distribution</strong><br>
                Understand the emotional breakdown of your content â€” are your posts mostly positive, neutral, or
                negative?<br><br>

                ğŸ“… <strong>Daily Post Activity</strong><br>
                Discover your personal posting habits. Find out which days you're most active and how your engagement
                varies over time.
            </p>
            <p><strong>Come and click! <a href="#top-feature">See Your Emotional Footprint ğŸ”</a></strong></p>
        </div>
        <!-- Sentiment Trend Chart Card -->
        <div id="trend-section" class="chart-section card shadow-sm rounded mb-4">
            <div class="card-body">
                <h5 class="card-title text-center">Sentiment Trend (Last 7 Days)</h5>
                <canvas id="trendChart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <!-- Overall Sentiment Distribution Chart Card -->
        <div id="distribution-section" class="chart-section card shadow-sm rounded mb-4">
            <div class="card-body">
                <h5 class="card-title text-center">Overall Sentiment Distribution</h5>
                <canvas id="distributionChart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <!-- Daily Activity Bar Chart Card -->
        <div id="activity-section" class="chart-section card shadow-sm rounded mb-4">
            <div class="card-body">
                <h5 class="card-title text-center">Daily Post Activity</h5>
                <canvas id="activityChart" style="max-height: 300px;"></canvas>
            </div>
        </div>

</section>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const dates = {{ dates| tojson }};
    const positive = {{ positive| tojson }};
    const neutral = {{ neutral| tojson }};
    const negative = {{ negative| tojson }};
    const postCounts = {{ post_counts| tojson }};
    const sentimentCounter = {{ sentiment_counter| tojson }};
    const categoryLabels = {{ category_labels| tojson }};
    const categoryValues = {{ category_values| tojson }};

    // æŠ˜çº¿å›¾
    new Chart(document.getElementById("categoryChart"), {
        type: "bar",
        data: {
            labels: categoryLabels,
            datasets: [{
                label: "News Category Count",
                data: categoryValues,
                backgroundColor: "rgba(54, 162, 235, 0.6)"
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // æŠ˜çº¿å›¾
    new Chart(document.getElementById('trendChart'), {
        type: 'line',
        data: {
            labels: dates,
            datasets: [
                { label: 'Positive', data: positive, borderColor: 'green' },
                { label: 'Neutral', data: neutral, borderColor: 'gray' },
                { label: 'Negative', data: negative, borderColor: 'red' }
            ],
            options: {
                responsive: true,
                maintainAspectRatio: false // ç¦æ­¢å›ºå®šæ¯”ä¾‹ï¼Œæ‰èƒ½çœŸæ­£æ‹‰ä¼¸
            }
        }
    });

    // é¥¼å›¾
    new Chart(document.getElementById('distributionChart'), {
        type: 'pie',
        data: {
            labels: Object.keys(sentimentCounter),
            datasets: [{
                data: Object.values(sentimentCounter),
                backgroundColor: ['green', 'gray', 'red']
            }],
            options: {
                responsive: true,
                maintainAspectRatio: false // ç¦æ­¢å›ºå®šæ¯”ä¾‹ï¼Œæ‰èƒ½çœŸæ­£æ‹‰ä¼¸
            }
        }
    });

    // æŸ±çŠ¶å›¾
    new Chart(document.getElementById('activityChart'), {
        type: 'bar',
        data: {
            labels: dates,
            datasets: [{
                label: 'Posts per Day',
                data: postCounts,
                backgroundColor: 'skyblue'
            }],
            options: {
                responsive: true,
                maintainAspectRatio: false // ç¦æ­¢å›ºå®šæ¯”ä¾‹ï¼Œæ‰èƒ½çœŸæ­£æ‹‰ä¼¸
            }
        }
    });

    // æ˜¾ç¤ºæŸä¸ªå›¾è¡¨åŒºåŸŸï¼Œéšè—å…¶ä»–åŒºåŸŸ
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll('.chart-section').forEach(section => {
            section.style.display = 'none';
        });

        // å¦‚æœåç«¯è¿”å›åˆ†ç±»å›¾è¡¨æœ‰æ•°æ®ï¼Œåˆ™æ˜¾ç¤º category-section
        {% if category_distribution %}
        document.getElementById('category-section').style.display = 'block';
        {% endif %}
    });

    function showSection(sectionId) {
        // éšè—æ‰€æœ‰å›¾è¡¨éƒ¨åˆ†
        const sections = document.querySelectorAll(".chart-section");
        sections.forEach(sec => sec.style.display = "none");

        // æ˜¾ç¤ºç›®æ ‡å›¾è¡¨éƒ¨åˆ†
        const target = document.getElementById(sectionId);
        if (target) {
            target.style.display = "block";
        }

        // åªæœ‰é category-section æ—¶æ‰æ»šåŠ¨åˆ° User Statistics åŒºåŸŸ
        if (sectionId !== 'category-section') {
            const statsHeader = document.getElementById("statistics-section");
            if (statsHeader) {
                statsHeader.scrollIntoView({ behavior: "smooth" });
            }
        }
    }
</script>

{% endblock %}