{% extends "base.html" %}

{% block title %}User Profile{% endblock %}

{% block content %}
<section class="container-left">
    <!-- 左侧导航栏 -->
    <div class="sidebar">
        <div class="list-group">
            <a href="#trend" class="nav-link">Finding</a>
            <a href="#trend" class="nav-link">Sentiment Trend</a>
            <a href="#distribution" class="nav-link">Sentiment Overview</a>
            <a href="#activity" class="nav-link">Post Activity</a>
        </div>
    </div>

    <!-- 右侧图表内容 -->
    <div class="content">
        <!-- 年龄和性别 -->
        <!-- 当前用户信息 -->
        <form method="POST" class="mb-4">
            {{ form.hidden_tag() }}
            <div class="row">
                <!-- 一次性保存的年龄 -->
                <div class="col-md-3">
                    <label>Age</label>
                    <input name="age" type="number" class="form-control" value="{{ user.age or '' }}">
                </div>

                <!-- 一次性保存的性别 -->
                <div class="col-md-3">
                    <label>Gender</label>
                    <select name="gender" class="form-control">
                        <option value="">Select</option>
                        <option value="Male" {% if user.gender=='Male' %}selected{% endif %}>Male</option>
                        <option value="Female" {% if user.gender=='Female' %}selected{% endif %}>Female</option>
                        <option value="Other" {% if user.gender=='Other' %}selected{% endif %}>Other</option>
                    </select>
                </div>

                <!-- 用于筛选：按性别 -->
                <div class="col-md-3">
                    <label>Filter by Gender</label>
                    <select name="gender_filter" class="form-control">
                        <option value="">None</option>
                        <option value="Male" {% if gender_filter=='Male' %}selected{% endif %}>Male</option>
                        <option value="Female" {% if gender_filter=='Female' %}selected{% endif %}>Female</option>
                        <option value="Other" {% if gender_filter=='Other' %}selected{% endif %}>Other</option>
                    </select>
                </div>

                <!-- 用于筛选：按年龄段 -->
                <div class="col-md-3">
                    <label>Filter by Age Group</label>
                    <select name="age_group" class="form-control">
                        <option value="">None</option>
                        <option value="20-30" {% if age_group=='20-30' %}selected{% endif %}>20–30</option>
                        <option value="30-40" {% if age_group=='30-40' %}selected{% endif %}>30–40</option>
                        <option value="40-50" {% if age_group=='40-50' %}selected{% endif %}>40–50</option>
                        <option value="50-60" {% if age_group=='50-60' %}selected{% endif %}>50–60</option>
                        <option value="60-70" {% if age_group=='60-70' %}selected{% endif %}>60–70</option>
                    </select>
                </div>
            </div>

            <div class="mt-3">
                <button type="submit" class="btn btn-primary">Apply Filters</button>
            </div>
        </form>

        {% if gender_filter %}
        <h5>News Category Distribution for Gender: {{ gender_filter }}</h5>
        {% elif age_group %}
        <h5>News Category Distribution for Age Group: {{ age_group }}</h5>
        {% endif %}

        {% if category_distribution %}
        <h5 class="mt-4">Category Distribution (Bar Chart)</h5>
        <canvas id="categoryChart" style="max-height: 300px;"></canvas>
        {% endif %}

        <h2 class="mb-4 text-center">📊 User Statistics</h2>
        <!-- Sentiment Trend Chart Card -->
        <div class="card shadow-sm rounded mb-4">
            <div class="card-body">
                <h5 class="card-title text-center">Sentiment Trend (Last 7 Days)</h5>
                <canvas id="trendChart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <!-- Overall Sentiment Distribution Chart Card -->
        <div class="card shadow-sm rounded mb-4">
            <div class="card-body">
                <h5 class="card-title text-center">Overall Sentiment Distribution</h5>
                <canvas id="distributionChart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <!-- Daily Activity Bar Chart Card -->
        <div class="card shadow-sm rounded mb-4">
            <div class="card-body">
                <h5 class="card-title text-center">Daily Post Activity</h5>
                <canvas id="activityChart" style="max-height: 300px;"></canvas>
            </div>
        </div>

</section>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const dates = {{ dates| tojson }};
    const positive = {{ positive| tojson }};
    const neutral = {{ neutral| tojson }};
    const negative = {{ negative| tojson }};
    const postCounts = {{ post_counts| tojson }};
    const sentimentCounter = {{ sentiment_counter| tojson }};
    const categoryLabels = {{ category_labels| tojson }};
    const categoryValues = {{ category_values| tojson }};

    // 折线图
    new Chart(document.getElementById("categoryChart"), {
        type: "bar",
        data: {
            labels: categoryLabels,
            datasets: [{
                label: "News Category Count",
                data: categoryValues,
                backgroundColor: "rgba(54, 162, 235, 0.6)"
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // 折线图
    new Chart(document.getElementById('trendChart'), {
        type: 'line',
        data: {
            labels: dates,
            datasets: [
                { label: 'Positive', data: positive, borderColor: 'green' },
                { label: 'Neutral', data: neutral, borderColor: 'gray' },
                { label: 'Negative', data: negative, borderColor: 'red' }
            ],
            options: {
                responsive: true,
                maintainAspectRatio: false // 禁止固定比例，才能真正拉伸
            }
        }
    });

    // 饼图
    new Chart(document.getElementById('distributionChart'), {
        type: 'pie',
        data: {
            labels: Object.keys(sentimentCounter),
            datasets: [{
                data: Object.values(sentimentCounter),
                backgroundColor: ['green', 'gray', 'red']
            }],
            options: {
                responsive: true,
                maintainAspectRatio: false // 禁止固定比例，才能真正拉伸
            }
        }
    });

    // 柱状图
    new Chart(document.getElementById('activityChart'), {
        type: 'bar',
        data: {
            labels: dates,
            datasets: [{
                label: 'Posts per Day',
                data: postCounts,
                backgroundColor: 'skyblue'
            }],
            options: {
                responsive: true,
                maintainAspectRatio: false // 禁止固定比例，才能真正拉伸
            }
        }
    });
</script>

{% endblock %}